// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}


enum UserRole {
    FARMER
    BUYER
    ADMIN
}

enum CropStatus {
    ACTIVE
    SOLD
    EXPIRED
    CANCELLED
}

enum BidStatus {
    PENDING
    ACCEPTED
    REJECTED
    EXPIRED
}

enum CropCategory {
    GRAINS
    VEGETABLES
    FRUITS
    PULSES
    OILSEEDS
    SPICES
    OTHER
}


model User {
    id            String    @id @default(cuid())
    name          String?
    email         String    @unique
    emailVerified DateTime?
    image         String?
    password      String?
    phone         String?
    role          UserRole  @default(FARMER)
    
    address       String?
    city          String?
    state         String?
    pincode       String?
    latitude      Float?
    longitude     Float?
    
    trustScore    Float     @default(0)
    totalRatings  Int       @default(0)
    avgRating     Float     @default(0)
    
    isActive              Boolean   @default(true)
    failedLoginAttempts   Int       @default(0)
    lockedUntil           DateTime?
    lastLoginAt           DateTime?
    passwordChangedAt     DateTime?
    twoFactorEnabled      Boolean   @default(false)
    twoFactorSecret       String?
    
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    accounts      Account[]
    sessions      Session[]
    

    cropListings  CropListing[]
    
    bids          Bid[]
    
    sentMessages     Message[] @relation("SentMessages")
    receivedMessages Message[] @relation("ReceivedMessages")
    
    ratingsGiven    Rating[] @relation("RatingsGiven")
    ratingsReceived Rating[] @relation("RatingsReceived")
    
    
    notifications   Notification[]
    
 
    auditLogs      AuditLog[]
    
    blockchainTransactions BlockchainTransaction[]

    @@index([role])
    @@index([city, state])
}

model Account {
    id                       String  @id @default(cuid())
    userId                   String
    type                     String
    provider                 String
    providerAccountId        String
    refresh_token            String? @db.Text
    access_token             String? @db.Text
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String? @db.Text
    session_state            String?
    user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    refresh_token_expires_in Int?

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}


model CropListing {
    id              String       @id @default(cuid())
    farmerId        String
    farmer          User         @relation(fields: [farmerId], references: [id], onDelete: Cascade)
    
    cropName        String
    category        CropCategory
    quantity        Float        
    unit            String       @default("quintal")
    expectedPrice   Float        
    minPrice        Float?       
    description     String?      @db.Text
    
    qualityGrade    String?
    isCertified     Boolean      @default(false)
    certifications  String[]
    
    
    images          String[]
    
    harvestLocation String?
    harvestDate     DateTime?
    
    status          CropStatus   @default(ACTIVE)
    expiresAt       DateTime?
    
    aiPredictedPrice    Float?
    aiSellTimeSuggestion String?
    aiConfidenceScore   Float?
    
    createdAt       DateTime     @default(now())
    updatedAt       DateTime     @updatedAt
    
    bids            Bid[]
    
    @@index([farmerId])
    @@index([cropName])
    @@index([category])
    @@index([status])
    @@index([createdAt])
}


model Bid {
    id            String    @id @default(cuid())
    listingId     String
    listing       CropListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
    buyerId       String
    buyer         User      @relation(fields: [buyerId], references: [id], onDelete: Cascade)
    
    bidAmount     Float     
    quantity      Float     
    totalAmount   Float     
    message       String?   @db.Text
    
    status        BidStatus @default(PENDING)
    
   
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    expiresAt     DateTime?
    
    @@index([listingId])
    @@index([buyerId])
    @@index([status])
    @@index([createdAt])
}


model Message {
    id          String   @id @default(cuid())
    senderId    String
    sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
    receiverId  String
    receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
    
    content     String   @db.Text
    isRead      Boolean  @default(false)
    
    createdAt   DateTime @default(now())
    
    @@index([senderId])
    @@index([receiverId])
    @@index([createdAt])
}


model Rating {
    id          String   @id @default(cuid())
    raterId     String
    rater       User     @relation("RatingsGiven", fields: [raterId], references: [id], onDelete: Cascade)
    ratedUserId String
    ratedUser   User     @relation("RatingsReceived", fields: [ratedUserId], references: [id], onDelete: Cascade)
    
    rating      Int      // 1-5
    review      String?  @db.Text
    
    createdAt   DateTime @default(now())
    
    @@unique([raterId, ratedUserId])
    @@index([ratedUserId])
}


model MandiPrice {
    id          String   @id @default(cuid())
    cropName    String
    variety     String?   
    
    mandiName   String
    state       String
    district    String
    
   
    minPrice    Float
    maxPrice    Float
    modalPrice  Float    
    
    
    priceDate   DateTime
    
    createdAt   DateTime @default(now())
    
    @@unique([cropName, variety, mandiName, priceDate])
    @@index([cropName])
    @@index([state, district])
    @@index([priceDate])
}


model AIPrediction {
    id              String   @id @default(cuid())
    cropName        String
    state           String
    district        String?
    
    predictedPrice  Float
    confidence      Float
    sellTimeSuggestion String?
    factors         Json?    
    
    validUntil      DateTime
    createdAt       DateTime @default(now())
    
    @@index([cropName, state])
    @@index([validUntil])
}


enum NotificationType {
    BID_RECEIVED
    BID_ACCEPTED
    BID_REJECTED
    MESSAGE_RECEIVED
    PRICE_ALERT
    LISTING_EXPIRED
    PAYMENT_RECEIVED
    SYSTEM
}

model Notification {
    id          String           @id @default(cuid())
    userId      String
    user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    type        NotificationType
    title       String
    message     String
    link        String?          
    data        Json?            
    
    isRead      Boolean          @default(false)
    createdAt   DateTime         @default(now())
    
    @@index([userId])
    @@index([isRead])
    @@index([createdAt])
}


enum AuditAction {
    SIGN_IN
    SIGN_OUT
    AUTH_ATTEMPT
    PASSWORD_CHANGE
    PROFILE_UPDATE
    LISTING_CREATE
    LISTING_UPDATE
    LISTING_DELETE
    BID_CREATE
    BID_UPDATE
    PAYMENT_INITIATED
    PAYMENT_COMPLETED
    MESSAGE_SENT
    ADMIN_ACTION
    TWO_FACTOR_ENABLED
    TWO_FACTOR_DISABLED
    TWO_FACTOR_VERIFIED
    TWO_FACTOR_FAILED
}

model AuditLog {
    id          String      @id @default(cuid())
    userId      String?
    user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
    
    action      AuditAction
    details     Json       
    ipAddress   String?
    userAgent   String?
    
    createdAt   DateTime    @default(now())
    
    @@index([userId])
    @@index([action])
    @@index([createdAt])
}


enum TransactionType {
    LISTING_CREATED
    BID_PLACED
    BID_ACCEPTED
    PAYMENT_COMPLETED
    RATING_GIVEN
    CONTRACT_SIGNED
}

model BlockchainTransaction {
    id                String          @id @default(cuid())
    userId            String
    user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    transactionType   TransactionType
    data              Json            
    dataHash          String          
    blockHash         String          
    previousBlockHash String?         
    nonce             Int             
    
    createdAt         DateTime        @default(now())
    
    @@index([userId])
    @@index([transactionType])
    @@index([blockHash])
    @@unique([blockHash])
}
